---
title: "Project"
author: "Eduardo Marenco"
subtitle: "Investigation into Chicago taxis"
echo: false
bibliography: references.bib
execute: 
  warning: false
fig-width: 6
fig-asp: 0.618
---

## Introduction

This is an exercise from the course on Data Visualization imparted by Professor Mine Cetinkaya and Professor Elijah Meyer at Duke University via Coursera. We will work with the data set taxi that contains information about tipping rates for 10,000 trips in the city of Chicago in 2022. The purpose of the exercise is to show proficiency in data exploration, data transformation, data visualization and statistical analysis based on two questions formulated by the Professors. First, I will upload the packages that I will use, then I will answer the two questions, and finally, I will answer a question formulated on my own.

## Packages

```{r}
#| warning: false
#| message: false
library(tidyverse)
library(tidymodels)
library(scales)

```

First, I took a look at the data set to get a sense of the data using View(taxi), glimpse and ?taxi commands. Throughout this analysis I will rely in the tidyverse, tidymodels, dplyr and scales packages.

## Question 1

I used ggplot2 to visualize the relationship between the variables tip and distance.

```{r}
#| label: load-packages
# Load ggplot2 for enhanced data visualization
library(ggplot2)
```

A box plot suggests that there may be a relationship between the distance traveled and tips left.

```{r}
#| label: distance-tip-boxplot
# Create the Box Plot using ggplot2
ggplot(taxi, aes(x = tip, y = distance, fill = tip)) +
  geom_boxplot() +
  labs(
    title = "Trip Distance Distribution by Tipping Status",
    x = "Tip Status",
    y = "Distance (miles)"
  ) +
  theme_minimal()
```

In fact, a density plot shows clearly that the distribution of tips concentrates below the 20 miles distance threshold, as shown below, where the peak for tipped trips (in red) is higher than for trips with no tip given.

```{r}
#| label: distance-tip-density plot
#| fig-cap: "Distribution of Trip Distance by Tipping Status"
ggplot(
  taxi,
  aes(x = distance, color = tip, fill = tip)
) +
  geom_density(alpha = 0.5)
```

A t test shows that the average distance for rides that received a tip was approximately 6.37 miles and that the the average distance for rides that did not receive a tip was approximately 4.57 miles. The mean distance for tipping rides is about 1.8 miles longer than non-tipping rides ($6.37 - 4.57$).

```{r}
#| label: two-sample-t-test
# Perform the Two-Sample t-Test (Distance ~ Tip)
# The formula syntax is: <quantitative_variable> ~ <categorical_variable>
t_test_result <- t.test(distance ~ tip, data = taxi)

# Print the results of the t-test
print(t_test_result)
```

In conclusion, there is a statistically significant difference in the mean trip distance between rides that received a tip and those that did not. Customers are significantly more likely to leave a tip on longer trips compared to shorter ones.

## Question 2

We want to know if people tip drivers from the company Chicago Independents more than drivers of other companies. I created a contingency table and a proportion table to examine the data. Then, I created a bar plot to check the relationship between tip rates and companies.

```{r}
#| label: company-tip-contingency tabl-bar plot
#| echo: false
#Creating a Contingency Table to examine the variable
# This shows the counts for each combination of 'company' and 'tip'
contingency_table <- table(taxi$company, taxi$tip)
print(contingency_table)

# Visualize Proportions (Optional but helpful)
# Convert to proportions within each company group to see the tipping rate
prop_table <- prop.table(contingency_table, margin = 1) # margin=1 for row proportions
print(prop_table)

# --- Data Preparation using Tidyverse ---
# 1. Convert the proportional table (matrix) into a data frame
prop_df <- as.data.frame.matrix(prop_table) 
# Assign 'company' names from the row names
prop_df$company <- rownames(prop_table) 

# 2. Reshape the data from wide to long format using tidyr::pivot_longer()
plot_data_long <- prop_df %>%
  pivot_longer(
    cols = !company, # Pivot all columns EXCEPT 'company'
    names_to = "tip_status",
    values_to = "proportion"
  )

# --- ggplot Visualization ---
ggplot(plot_data_long, aes(x = company, y = proportion, fill = tip_status)) +
  
  # Create the bar plot
  geom_bar(stat = "identity", position = "stack") +
  
  # Apply your specific colors
  scale_fill_manual(
    values = c("yes" = "salmon", "no" = "turquoise3"),
    name = "Tip Given"
  ) +
  
  # Add labels and titles
  labs(
    title = "Tipping Rate by Taxi Company (Proportional)",
    x = "Taxi Company",
    y = "Proportion of Trips"
  ) +
  
  # Optional: Improve x-axis readability
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Next, I performed a Chi-squared test to formally examine the relationship between tip (a binary/dichotomous variable) and company (categorical). I created a new variable to compare the company Chicago Independents with the rest of companies which is the most concrete relationship that we were asked to examine.

Based on the p-value obtained in this test (.003) we can reject the null hypothesis that there is not association between the taxi company group (Chicago Independent vs others) and the tipping outcome and we can conclude that data strongly suggests that the tipping rate for Chicago Independents is significantly higher (94.88 percent) than for other companies (91.85 percent) at the five percent level of significance.

```{r}
#| label: company-tip-chi squared test
# Creating a new binary company variable: 'Independents' vs. 'Other'
taxi$independents_group <- ifelse(taxi$company == "Chicago Independents", "Chicago Independents", "Other")
# Check the new variable structure (optional)
table(taxi$independents_group)

# Creating the 2x2 contingency table (Independents vs. Other, Tip Yes vs. No)
indep_vs_other_table <- table(taxi$independents_group, taxi$tip)
print(indep_vs_other_table)

# 2. Perform the Chi-squared test on the 2x2 table
indep_chi_square_result <- chisq.test(indep_vs_other_table)
print(indep_chi_square_result)


```

## Good predictors of tipping rate

I wanted to know which of the variables of the data set taxi would be a significant predictor of tip (a binary variable). Thus, I ran a logistic regression model to answer this question. From the output we can see that distance is a significant predictor for tipping rates along with levelsthe trip starting and ending in locations from different communities. Also, people tend to tip more during the month of April and people tend not to tip particular companies, probably due to poor service. Finally, for some reason, people tip less on Friday.

```{r}
#| label: tip-rest of variables-logistic regression
# Load the necessary tidyverse library (dplyr is useful for any data prep)
library(dplyr) 

# --- Prepare/Verify the Data (Recommended Step) ---
# Ensure 'tip' is a factor and the desired outcome level ('yes') is the reference level (if needed)
# For logistic regression, R models the probability of the SECOND factor level.
# To ensure R models P(tip = "yes"), you may need to reorder levels if "yes" is not second.
# Check current levels: levels(taxi$tip)
# If levels are c("no", "yes"), then P(tip = "yes") is modeled.
# If levels are c("yes", "no"), R models P(tip = "no").
# To explicitly model P(tip = "yes"):
taxi$tip <- factor(taxi$tip, levels = c("no", "yes")) 
print(levels(taxi$tip)) # Output should now be: [1] "no" "yes"

# --- Run the Logistic Regression Model ---

# Model formula: tip is predicted by all other relevant variables.
# We omit 'Time' as it seems irrelevant based on its description.
logistic_model <- glm(tip ~ distance + company + local + dow + month + hour, 
                      data = taxi, 
                      family = "binomial")

# Print the model summary to see coefficients, p-values, and model fit statistics
summary(logistic_model)
```
